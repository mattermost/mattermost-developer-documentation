<!DOCTYPE html>





<html>

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title> Automating Nodes Rotation Using Gitlab Pipelines</title>
<meta name="viewport" content="width=device-width, initial-scale=1">  
<meta http-equiv="content-language" content="en-us" />

<meta name="og:site_name" value="Mattermost.com">
<meta name="og:title" value="Automating Nodes Rotation Using Gitlab Pipelines">

 
  <meta name="description" content="This blog post describes our journey to automate our nodes rotation process when we have a new AMI release, and the open source tools we built on this.">
<meta name="twitter:description" content="This blog post describes our journey to automate our nodes rotation process when we have a new AMI release, and the open source tools we built on this.">
<meta name="og:description" content="This blog post describes our journey to automate our nodes rotation process when we have a new AMI release, and the open source tools we built on this.">



 
<link rel="canonical" href="https://developers.mattermost.com/blog/automating-nodes-rotation/">


<link rel="shortcut icon" type="image/png" href="https://developers.mattermost.com/img/favicon-32x32.png" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">


<link rel="stylesheet" href="https://developers.mattermost.com/css/bootstrap.min.css">
<link rel="stylesheet" href="https://developers.mattermost.com/css/tabs.css">
<link rel="stylesheet" href="https://developers.mattermost.com/css/bar.css">
<link rel="stylesheet" href="https://developers.mattermost.com/css/styles.css">
<link rel="stylesheet" href="https://developers.mattermost.com/css/code.css">
<link rel="stylesheet" href="https://developers.mattermost.com/css/note.css">

<script async defer src="https://buttons.github.io/buttons.js"></script>


<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-53S4TVZ');</script>


</head>

<body class="blog-single">
    
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-53S4TVZ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>


    
<header class="with-notification-bar">

    <a href="https://developers.mattermost.com/"><img src="https://developers.mattermost.com/img/logo.svg" alt="Mattermost Logo" width="212px"></a>
    <div class="header__menu-toggle">
        <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links--right">
        <li><a href="https://developers.mattermost.com/">Home</a></li>
        
            
            
            
                
                    <li><a href="https://developers.mattermost.com/contribute/getting-started/">Contribute</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://developers.mattermost.com/integrate/getting-started/">Integrate</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://developers.mattermost.com/extend/getting-started/">Extend</a></li>
                
            
        
            
            
            
                
                    <li class="active"><a href="https://developers.mattermost.com/blog/">Blog</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://docs.mattermost.com/">Admin Docs</a></li>
                
            
        
    </ul>
</header>


<div class='notification-bar sticky-top'>
    <div class="notification-bar__content">
        <a class="notification-bar__close">
            <span aria-hidden="true">×</span>
        </a>
        <a href="https://mattermost.com/careers">
            We&#39;re hiring!
        </a>
    </div>
</div>




    <div class="container">
        <div class="row">
            <div class="col-md-9 doc-content">
                <div class="well well-sm">
                    <div class="blog-item__header">
                        <div class="blog-item__title">
                            <h1>
                            
                                Automating Nodes Rotation
                            
                            </h1>
                            <small>This blog post describes our journey to automate our nodes rotation process when we have a new AMI release, and the open source tools we built on this.</small>
                            
                        </div>
                        <div class="blog-item__info">
                            April 19, 2021
                            <small class="blog-item__count">587 words</small>
                        </div>
                    </div>
                    <hr>
                    <h4 id="overview">Overview&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#overview"></i></a> </h4>
<p>In the daily life of a Site Reliability Engineer the main goal is to reduce all the work we call toil. But what is toil? Toil is the kind of work tied to running a production service that tends to be manual, repetitive, automatable, tactical, devoid of enduring value, and that scales linearly as a service grows.
This blog post describes our journey to automate our nodes rotation process when we have a new AMI release, and the open source tools we built on this.</p>
<h4 id="problems">Problems&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#problems"></i></a> </h4>
<p>Apart from toil elimination we had specific problems that we needed to solve by building our tooling around:</p>
<ul>
<li>Our first problem is the limited way in which Kubernetes Operations (kops) rolls out node changes. It does it sequentially, one by one and in a specific window of time. We needed a much more flexible way of rotation, to avoid stretching our workloads or hitting any limits on our infrastructure. Each environment might need different handling to be more efficient and as reliable as possible during this process.</li>
<li>The second problem is that AWS EKS clusters have no automated way rolling out new nodes after a new AMI is released. To build this ability is essential, especially when it comes to releases which are related to security patches and should be in place as soon as possible.</li>
</ul>
<h4 id="solution">Solution&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#solution"></i></a> </h4>
<p>To solve the above-mentioned problems we combined existing tooling that we had in place such as our cloud provisioner and our GitLab Pipelines with the new tools we implemented. Below are the steps we took to achieve this.</p>
<ul>
<li>Implemented a new library (rotator) that improved nodes rotation functionality. It provided us with a much more flexible, configurable, and reliable way to rotate nodes.</li>
<li>Added it as a module on our cloud provisioner of our workloads (kops) clusters.</li>
<li>Created a cli tool for rotator (rotatorctl) to use it from our local machines and our GitLab pipelines to rotate EKS clusters.</li>
<li>Created GitLab  pipelines to release new AMIs for kops clusters using cloud provisioner with rotator module and its improved capabilities in-place.</li>
<li>Created GitLab pipelines for releasing new AMIs on EKS clusters using rotatorctl.</li>
</ul>
<figure>
    <img src="https://developers.mattermost.com/blog/2021-04-19-nodes-automation-image/kops-flow.png"
         alt="Kops Pipeline Flow"/> 
</figure>

<p>The flow of node rotation for our kops clusters</p>
<figure>
    <img src="https://developers.mattermost.com/blog/2021-04-19-nodes-automation-image/eks-flow.png"
         alt="EKS Pipeline Flow"/> 
</figure>

<p>The flow of node rotation for our AWS EKS clusters</p>
<h4 id="why-is-this-important">Why is this important?&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#why-is-this-important"></i></a> </h4>
<p>As we stated initially, all this work helped our team to get rid of a significant amount of toil work. By automating and improving these processes saved a lot of valuable time for the SRE team, before putting them in place there were cases that 2 or 3 people needed to participate and closely monitor these tasks.</p>
<p>Especially in the case of kops clusters, which rotate their nodes, this is a time-consuming task (2 to 8 hours depending on the cluster size and the environment) so investing on tooling over toil was a great choice.</p>
<p>This choice gave to our team the ability to roll out more regular AMI changes, which has resulted in a more secure and better performing underlying infrastructure. This way we can focus on what really matters, which is to serve a reliable and more secure cloud offering for our customers.
These tools are not only useful for our team but for the wider community, as they solve a problem that many Operations and SRE teams are facing. Offering back tooling to the Open Source community for managing their infrastructure and their workloads is a core principle in our team.</p>
<h4 id="resources">Resources&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#resources"></i></a> </h4>
<ul>
<li>
<p><a href="https://github.com/mattermost/mattermost-cloud/pull/423">Add rotation ability to mattermost-cloud provisioner</a></p>
</li>
<li>
<p><a href="https://github.com/mattermost/rotator">Rotator Library</a></p>
</li>
<li>
<p><a href="https://github.com/mattermost/rotatorctl">Rotator CLI</a></p>
</li>
</ul>
<h4 id="references">References&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#references"></i></a> </h4>
<ul>
<li><a href="https://sre.google/sre-book/eliminating-toil/">Eliminating Toil</a></li>
</ul>


                    <hr>
                    
                    Written by
                    
                    Stavros Foteinopoulos
-
<a href="https://community.mattermost.com/core/messages/@stavros.foteinopoulos" target="_blank">
    @stavros.foteinopoulos
</a>
on
<a href="https://community.mattermost.com/signup_user_complete" target="_blank">
    community.mattermost.com
</a>
and
<a href="https://github.com/stafot" target="_blank">
    @stafot
</a>
on GitHub

                    
                    
                    <br />
                    <br />
                    Join us on <a href="https://community.mattermost.com/signup_user_complete"
                        target="_blank">community.mattermost.com</a>!
                </div>
            </div>

            
            <div class="col-md-3 doc-content tags-sidebar">
                <div class="well well-sm">

                    


                    <h6>Other Posts</h6>
                    <ul class="list-unstyled">
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/migrating-thousands-of-mattermost-installations-to-new-kubernetes-custom-resources/">Migrating thousands of Mattermost installations to new Kubernetes Custom Resources</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/optimizing-go-compiler-3/">Fixing a bug in the Go compiler as a newbie: a deep dive (III)</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/optimizing-go-compiler-2/">Fixing a bug in the Go compiler as a newbie: a deep dive (II)</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/optimizing-go-compiler-1/">Fixing a bug in the Go compiler as a newbie: a deep dive (I)</a></li>
                        
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/streamlining-developer-access-to-prometheus-and-grafana/">Streamlining Developer Access to Prometheus and Grafana</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/common-i18n-mistakes/">Avoiding Common Internationalization Mistakes</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/mysql-index-merge/">Tuning MySQL and the Ghost of Index Merge Intersection</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/docker-content-trust-in-gitlab-with-delegation/">Docker Content Trust in GitLab&#39;s .gitlab-ci.yml with Delegation</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/improving-performance-through-load-testing/">Improving performance (and more) through load testing</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/automated-ui-testing-with-cypress/">Automated UI Testing With Cypress</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/pritunl/">From OpenVPN to Pritunl VPN: The transition</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/open-tracing/">OpenTracing for Go Projects</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="https://developers.mattermost.com/blog/hands-on-iouring-go/">Getting Hands-on with io_uring using Go</a></li>
                        
                        
                    </ul>
                    <h6>Categories</h6>
                    <ul class="list-unstyled">
                           
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <footer class="text-center">
    <div class="container-fluid">
        <div class="footer__copyright">© Mattermost, Inc. All Rights Reserved.</div>
        <div class="footer__icons">
            <a href="https://www.facebook.com/Mattermost-2300985916642531/" target="_blank" rel="noopener noreferrer" class="btn-primary"><i class="fa fa-facebook"></i></a>
            <a href="https://twitter.com/mattermost" target="_blank" rel="noopener noreferrer" class="btn-primary"><i class="fa fa-twitter"></i></a>
            <a href="https://www.youtube.com/channel/UCNR05H72hi692y01bWaFXNA" target="_blank" rel="noopener noreferrer" class="btn-primary"><i class="fa fa-youtube"></i></a>
        </div>
    </div>
</footer>


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
<script src="https://developers.mattermost.com/js/tabs.js"></script>
<script src="https://developers.mattermost.com/js/main.js"></script>

</body>

</html>
